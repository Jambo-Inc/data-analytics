name: "Jambo Default"
description: "デフォルトのJambo分析テンプレート"

system_preamble: |
  ## 基本ルール
  - タイムゾーンは全てJST（Asia/Tokyo）で処理・表示すること
  - 日付フィルタは必ずTIMESTAMP型でJSTに変換して比較すること

  ## 表示ルール
  - ユーザー情報を表示する際は必ず user_id, name, application_idを含める
    - もし、application_idの変換後の値が設定されていない場合は、そのままapplication_idを返す

  ## テーブル固有の制約
  - 期間指定がない場合は「期間を指定してください」とガイド
    - 「昨日」は前日1日分

  ## 用語定義
  - 「上位」= 降順（DESC）

  ## SQL生成ルール
  - LIMIT句は必ず付与（デフォルト1000）
  - ORDER BYは必ず指定

  ## カラム型に関する注意
  - `timestamp_jst`カラムはDATETIME型である（TIMESTAMPではない）
  - DATETIME型にDATE関数を使う場合は引数1つのみ: `DATE(timestamp_jst)` ✓
  - タイムゾーン引数を付けてはいけない: `DATE(timestamp_jst, 'Asia/Tokyo')` ✗ ← エラーになる

tables:
  - project_id: "jambo-data-science"
    dataset_id: "curated_prod"
    table_id: "transaction_log"
    description: "アプリ内購入ログ"
  - project_id: "jambo-data-science"
    dataset_id: "curated_prod"
    table_id: "log_point"
    description: |
      "ポイント獲得・消費ログテーブル"
      user_id: ポイントを獲得・消費したユーザーのuser_id
      partner_id: user_idとのやりとりによってポイントを獲得・消費したユーザーのuser_id
      type: やりとり(partner_idあり)やアクション(partner_id)の種類
        - 1: 登録
        - 2: デイリーボーナス
        - 4: 課金（購入）
        - 15: 音声通話
        - 16: ビデオ通話
        - 17: チャット送信
        - 20: 画像閲覧
        - 21: 画像閲覧ボーナス
        - 23: スタンプ送信
        - 24: スタンプ受信
        - 37: チャット受信
        - 75: 動画視聴
        - 76: 動画視聴ボーナス
        - 82: 合算
        - 84: デイリーボーナス2倍
        - 104: （初回アプリ）ビデオLovenseメニュー支払い
        - 105: （初回アプリ）ビデオLovenseメニュー付与
        - 209: （2nd）音声ポイント付与
        - 210: ライブ配信ポイント消費（ライブチャット）
        - 211: ライブ配信ポイント付与（ライブチャット）
        - 212: ライブビデオポイント付与
        - 213: ライブビデオポイント消費
        - 281: ウィークリーチャレンジボーナス
        - 334: （男性）ビデオ通話 復元
        - 上記以外のタイプ: その他
  - project_id: "jambo-data-science"
    dataset_id: "curated_prod"
    table_id: "user"
    description: |
      ユーザー情報テーブル

      ## カラム変換ルール
      ### gender
      - 0 : 男性
      - 1 : 女性

relationships:
  - "user.user_id = log_point.user_id"
  - "user.user_id = transaction_log.user_id"
  - "user.user_id = log_web_payment_point.user_id"

#
#example_queries:
#  - question: "昨日最も課金したユーザー10名"
#    sql: |
#      SELECT user_id, SUM(net_revenue) as total
#      FROM marts.purchase_log
#      WHERE DATE(purchased_at, 'Asia/Tokyo') = DATE_SUB(CURRENT_DATE('Asia/Tokyo'), INTERVAL 1 DAY)
#      GROUP BY user_id
#      ORDER BY total DESC
#      LIMIT 10
#  - question: "対象ユーザーの直近7日間チャット（最大100件）"
#    sql: |
#      SELECT user_id, partner_id, message, sent_at
#      FROM curated.chat_log
#      WHERE user_id = @target_user_id
#        AND sent_at >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
#      ORDER BY sent_at DESC
#      LIMIT 100
