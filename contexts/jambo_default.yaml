name: "Jambo Default"
description: "デフォルトのJambo分析テンプレート"

system_preamble: |
  ## 基本ルール
  - タイムゾーンは全てJST（Asia/Tokyo）で処理・表示すること

  ## テーブル固有の制約
  - 期間指定がない場合は「期間を指定してください」とガイド。それでも指定がなければ「昨日分」を取得する。
    - 「昨日」は前日1日分

  ## 用語定義
  - 「上位」= 降順（DESC）

  ## SQL生成ルール
  - ORDER BYは必ず指定
  - log系テーブル（transaction_log, log_web_payment_point, log_point）は`timestamp_jst`カラムでパーティショニングされている
    - 必ず`timestamp_jst`を使って期間を絞り込むこと（パーティションプルーニングを有効化）
    - 例: `WHERE timestamp_jst >= '2025-01-01' AND timestamp_jst < '2025-01-02'`
    - パーティションフィルタがないクエリは実行コストが高いため禁止

  ## ポイント集計ルール（log_point_daily_view）
  - アプリ名で絞り込む場合: `LOWER(partner_app_name) LIKE LOWER(REPLACE('アプリ名%', '-', '_'))` を使用
  - ポイント（total_point）の集計時:
    - 17(管理変更ポイント), 340(ロールバックポイント)は必ず除外すること
    - 獲得ポイント（正の値）を集計する場合: typeが以下の場合は除外
      - 4(購入), 258(credit), 306(paidy), 321(amazon_pay), 322(google_pay), 323(apple_pay)
      - 82(合算による加算)
    - 消費ポイント（負の値）を集計する場合: 38(精算)は除外すること

  ## 課金（ポイント購入）の集計ルール
  - 「課金」「ポイント購入」を調べる場合:
    - action_type IN (4, 258, 306, 321, 322, 323) で絞り込む
    - 課金額はtotal_pointの正の値（total_point > 0）で表される
    - 課金上位 = total_pointが大きい順（DESC）

  ## 出力フォーマット
  - 複数ユーザーの結果を表示する際は、ユーザーごとに改行して見やすく整形する

  ## 表示ルール
  - ユーザー情報を表示する際は必ず user_id, name, application_nameを含める
    - もし、application_idの変換後の値が設定されていない場合は、そのままapplication_idを返す

  ## カラム型に関する注意
  - `timestamp_jst`カラムはDATETIME型である（TIMESTAMPではない）
  - DATETIME型にDATE関数を使う場合は引数1つのみ: `DATE(timestamp_jst)` ✓
  - タイムゾーン引数を付けてはいけない: `DATE(timestamp_jst, 'Asia/Tokyo')` ✗ ← エラーになる

tables:
  - project_id: "jambo-data-science"
    dataset_id: "marts_prod"
    table_id: "log_point_daily_view"
    description: |
      ユーザーポイントログ情報
      ## スキーマ情報
      - date: DATE
      - user_id: STRING
      - user_app_name: STRING（例: "Jambo_iOS", "Jambo_Android"）
        - アプリ名で絞り込む場合は LOWER(user_app_name) LIKE LOWER(REPLACE('アプリ名%', '-', '_')) を使用すること
      - partner_id: STRING(NULLABLE)
      - partner_app_name: STRING（例: "Jambo_iOS", "Jambo_Android"）
        - アプリ名で絞り込む場合は LOWER(partner_app_name) LIKE LOWER(REPLACE('アプリ名%', '-', '_')) を使用すること
      - point: total_point
        - 正 : 獲得ポイント
        - 負 : 消費ポイント
      ## カラム変換ルール
      ### user_gender, partner_gender
       - 0 : 男性
       - 1 : 女性